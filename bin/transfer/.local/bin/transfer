#!/usr/bin/env bash
# vi:set ft=sh ts=4 sw=4 noet noai:
# shellcheck shell=bash

msg() {
	echo >&2 -e "${1-}"
}

die() {
	local msg=$1
	local code=${2-1}
	msg "$msg"
	exit "$code"
}

urlencode() {
	if hash jq 2>/dev/null; then
		printf '%s' "$(jq -sRr @uri < <(printf "%s" "$1"))"
	else
		local length=${#1}
		for ((i = 0; i < length; i++)); do
			local c=${1:i:1}
			case $c in
			[a-zA-Z0-9.~_-]) printf '%s' "$c" ;;
			*) printf '%%%02X' "'$c" ;;
			esac
		done
	fi
}

transfer() {
	if (($# < 1)); then
		die 'No arguments specified.\nUsage:\n  transfer <file|directory>\n  ... | transfer <file_name>\n'
	fi

	local fname
	if tty -s; then
		file=$1
		fname=$(urlencode "$(basename "$file")")

		if [[ ! -e $file ]]; then
			die "${file}: No such file or directory"
		fi

		if [[ -d $file ]]; then
			fname=${fname}.zip
			(cd "$file" && zip -r -q - .) | curl --include --progress-bar --upload-file "-" "https://file.unsha.re/${fname}"
		else
			curl --include --progress-bar --upload-file "-" "https://file.unsha.re/${fname}" <"$file"
		fi
	else
		fname=$(urlencode "$1")
		curl --include --progress-bar --upload-file "-" "https://file.unsha.re/${fname}"
	fi
	msg ''
}

transfer "$@"
