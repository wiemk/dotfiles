#!/usr/bin/env bash
# shellcheck shell=bash
# shellcheck disable=2155,1090

# burn in English subtitle track and transcode to constant quality 8bit h264 yuv420p, Japanese audio

# shellcheck source=../../../../share/lib/.local/share/dotfiles/lib/lib.sh
source "${0%/*}/../share/dotfiles/lib/lib.sh" || exit 1

declare workdir
if (($# < 1)); then
	workdir=$PWD
elif [[ -d $1 ]]; then
	workdir=$1
else
	die "Not a valid directory: ${1}"
fi

if ! has_emit HandBrakeCLIs; then
	exit 1
fi

workdir=$(readlink -f -- "$workdir")

numfiles() {
	find "$1" -maxdepth 1 -type f -iname "*.mkv" -printf . | wc -c
}

assburn() {
	# shellcheck disable=SC1004
	find "$1" -maxdepth 1 -type f -iname "*.mkv" \( -exec sh -c 'i="$1" base="$(dirname "$1")/$(basename "$1" .mkv)"; \
			systemd-run --quiet --user --collect --pty --nice=19 --property=CPUSchedulingPolicy=idle --property=IOSchedulingClass=idle \
			taskset -c 1-$(($(nproc)-1)):2 \
			HandBrakeCLI --input "$i" --encoder x264 --encoder-preset faster --encoder-tune animation \
			--encoder-profile high --encoder-level 5.2 --quality 18 -vfr --turbo \
			--audio-lang-list jpn --first-audio --aencoder copy --audio-copy-mask aac,ac3,eac3,truehd,dts,dtshd,mp3 \
			--audio-fallback av_aac --ab 160 --mixdown stereo --normalize-mix --arate auto --native-language eng \
			--subtitle-lang-list eng,und --first-subtitle --subtitle-burned \
			--output "${base}.new.mp4" && echo mv -vuf "${base}.new.mp4" "${base}.mp4"' \
		shell {} \; -o -quit \) || exit 1

	command ls --color=auto --show-control-chars --group-directories-first -AlhXF "$1"
}

if (($(numfiles "$workdir") < 1)); then
	die "No files to process found."
fi

assburn "$workdir"

# vi: set ft=sh ts=4 sw=0 sts=-1 sr noet nosi tw=0 fdm=manual: